<!doctype html>
<html lang="es">
<head>
    <title>Movie | Cineclick</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet" crossorigin="anonymous"
    />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&family=Montserrat:wght@400;600;800&display=swap"
        rel="stylesheet"
    />

    <style>
        :root {
            --orange: #F58F29;
            --blue: #058ED9;
            --dark: #212529;
        }

        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #ffffff;
        }

        .sidebar { width: 80px; background-color: var(--dark); color: white; display: flex; flex-direction: column; align-items: center; padding-top: 15px; position: fixed; height: 100vh; left: 0; top: 0; z-index:1000; }
        .sidebar .logo { width: 45px; height: 45px; border-radius: 50%; margin-bottom: 20px; }
        .sidebar .nav-link { color: var(--blue); font-weight: 500; text-align: center; margin: 8px 0; transition: 0.3s; font-size: 13px; text-decoration: none; }
        .sidebar .nav-link i { display: block; font-size: 20px; margin-bottom: 3px; }
        .sidebar .nav-link:hover { color: white; background-color: var(--orange); border-radius: 8px; width: 60%; }

        .main-container { margin-left: 80px; width: calc(100% - 80px); display:flex; flex-direction:column; min-height:100vh; }
        .top-navbar { background-color: var(--dark); padding: 18px; color: white; }
        .create-btn { background-color: var(--orange); border: none; color: white; padding: 7px 16px; border-radius: 8px; font-weight: bold; }
        .content { padding: 25px; }

        #movie-poster { width:200px; height:300px; object-fit:cover; border-radius:8px; margin-right:20px; box-shadow:0 4px 8px rgba(0,0,0,0.2); border:3px solid var(--blue); }

        .btn-rate { background-color: var(--blue); color: white; border: none; border-radius: 6px; padding: 5px 12px; font-weight: bold; }
        .btn-rate:hover { background-color: var(--dark); }

        .tags span { display:inline-block; background-color: var(--blue); color:white; padding:5px 10px; border-radius:6px; margin-right:5px; }
        .heart-icon { color: var(--blue); font-size:22px; cursor:pointer; }
        .heart-icon.active { color: var(--blue); }
        .modal-content { border: 3px solid var(--blue); border-radius: 12px; }
        .modal-header { background-color: var(--blue); color: white; border-radius: 10px 10px 0 0; }
        .btn-orange { background-color: var(--orange); color: white; border: none; border-radius: 8px; padding: 8px; }
    
    
        /* --- Estilo para las tarjetas de reseñas --- */
        .review-card {
            background: #f8f9fa;
            border: 2px solid var(--blue);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            transition: 0.2s ease;
        }

        .review-card:hover {
            transform: translateY(-2px);
        }

        /* Nombre del usuario */
        .review-user {
            font-weight: 700;
            font-size: 1rem;
            color: var(--blue);
        }

        /* Título de la reseña */
        .review-title {
            font-weight: 600;
            color: var(--dark);
            margin-top: 5px;
        }

        /* Texto */
        .review-text {
            font-size: 0.95rem;
            margin-top: 5px;
        }

        /* Contenedor de iconos (editar/borrar) */
        .review-actions {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .review-actions i {
            cursor: pointer;
            margin-left: 10px;
            font-size: 18px;
            color: var(--blue);
            transition: 0.2s ease;
        }

        .review-actions i:hover {
            color: var(--orange);
            transform: scale(1.2);
        }

    </style>
</head>

<body>
    
    <div class="sidebar">
        <img src="../assets/Icono.png" alt="Logo" class="logo" />
        <a href="PW_Profile.html" class="nav-link"><i class="fas fa-user"></i>Profile</a>
        <a href="PW_Home.html" class="nav-link"><i class="fas fa-home"></i>Home</a>
        <a href="PW_Search.html" class="nav-link"><i class="fas fa-film"></i>Movie</a>
        <a href="PW_settings.html" class="nav-link"><i class="fas fa-cog"></i>Setting</a>
        <a href="PW_help.html" class="nav-link"><i class="fas fa-question-circle"></i>Help</a>
    </div>

    <div class="main-container">
        <nav class="navbar navbar-dark top-navbar">
            <div class="container-fluid d-flex align-items-center justify-content-between">
                <form class="d-flex w-75">
                    <input class="form-control" type="text" placeholder="Search..." />
                </form>
                <div class="d-flex align-items-center">
                    <button class="create-btn ms-3" type="button" data-bs-toggle="modal" data-bs-target="#modalResena">+ Create</button>
                    <button class="btn text-white ms-3" id="logoutBtn" title="Cerrar sesión"><i class="fas fa-sign-out-alt fa-lg"></i></button>
                </div>
            </div>
        </nav>

        <!-- MODAL LOGOUT -->
        <div class="modal fade" id="modalLogout" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold"><i class="fas fa-sign-out-alt me-2"></i> Confirmar cierre de sesión</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="fw-semibold">¿Estás seguro de que deseas cerrar sesión?</p>
                    </div>
                    <div class="modal-footer border-0 justify-content-center pb-4">
                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn-orange px-4" id="confirmLogout">Cerrar sesión</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CATEGORÍA -->
        <div class="modal fade" id="modalCategoria" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Añadir categoría</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">Nueva categoría</label>
                        <input id="newCategory" class="form-control" placeholder="Ej: Acción" />
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn-orange w-100" id="addCategoryBtn">Agregar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CREAR RESEÑA -->
        <div class="modal fade" id="modalResena" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Crear reseña</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body px-4">
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input type="text" class="form-control" id="tituloResena" placeholder="Escribe el título..." />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reseña</label>
                            <textarea class="form-control" id="cuerpoResena" rows="5" placeholder="Escribe tu reseña..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn-orange w-100 fw-bold" id="btnPublicarResena">Publicar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CALIFICAR -->
        <div class="modal fade" id="modalCalificar" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Calificar película</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p class="mb-2">Selecciona tu puntuación</p>
                        <div id="starContainer" class="stars" style="justify-content:center; gap:8px;">
                            <i class="far fa-star fa-2x" data-value="1"></i>
                            <i class="far fa-star fa-2x" data-value="2"></i>
                            <i class="far fa-star fa-2x" data-value="3"></i>
                            <i class="far fa-star fa-2x" data-value="4"></i>
                            <i class="far fa-star fa-2x" data-value="5"></i>
                            <i class="far fa-star fa-2x" data-value="6"></i>
                            <i class="far fa-star fa-2x" data-value="7"></i>
                            <i class="far fa-star fa-2x" data-value="8"></i>
                            <i class="far fa-star fa-2x" data-value="9"></i>
                            <i class="far fa-star fa-2x" data-value="10"></i>
                        </div>
                        <input type="hidden" id="selectedRating" value="0" />
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn-orange w-100" id="submitRatingBtn">Enviar valoración</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="content">
            <div class="film-info d-flex align-items-start mt-3">
                <img src="" id="movie-poster" alt="Poster de la Película" />
                <div>
                    <div class="d-flex align-items-center gap-2">
                        <h3 class="film-title" id="movie-title">Cargando...</h3>
                        <div class="film-meta">
                            <span id="movie-year">N/A</span> · Dir. <span id="movie-director">N/A</span>
                        </div>
                    </div>
                    <p class="mt-3" id="movie-description">Cargando sinopsis...</p>
                    <div class="d-flex align-items-center gap-3 mt-2">
                        <button class="btn-rate" data-bs-toggle="modal" data-bs-target="#modalCalificar">Calificar</button>
                        <button class="btn-rate" data-bs-toggle="modal" data-bs-target="#modalResena">Crear Reseña</button>
                    </div>
                    <div class="tags d-flex align-items-center gap-2 mt-3" id="movie-tags">
                        <button type="button" data-bs-toggle="modal" data-bs-target="#modalTag">+</button>
                        <i class="far fa-heart heart-icon ms-2" id="heartIcon"></i>
                    </div>
                <!-- MODAL CREAR TAG PERSONALIZADO -->
                <div class="modal fade" id="modalTag" tabindex="-1" aria-labelledby="modalTagLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalTagLabel">Crear etiqueta personalizada</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="text" class="form-control" id="inputTagName" placeholder="Nombre de la etiqueta">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="btnCreateTag">Crear</button>
                            </div>
                        </div>
                    </div>
                </div>
                    <script>
                        // ...existing code...
                        import("./../scripts/watchlist.js").then(() => {
                            const heart = document.getElementById("heartIcon");
                            const movieId = new URLSearchParams(window.location.search).get("id");

                            async function renderCustomTags() {
                                const tagsContainer = document.getElementById("movie-tags");
                                // Elimina tags previos
                                tagsContainer.querySelectorAll(".custom-tag").forEach(e => e.remove());
                                const tags = await getTagsByMovie(movieId);
                                tags.forEach(tag => {
                                    const span = document.createElement("span");
                                    span.textContent = tag.name;
                                    span.className = "custom-tag";
                                    // Solo el dueño puede eliminar
                                    if (String(tag.id_user) === String(USER_ID)) {
                                        const del = document.createElement("i");
                                        del.className = "fas fa-times ms-1";
                                        del.style.cursor = "pointer";
                                        del.onclick = async () => {
                                            if (confirm("¿Eliminar etiqueta?")) {
                                                await deleteTag(tag.id);
                                                renderCustomTags();
                                            }
                                        };
                                        span.appendChild(del);
                                    }
                                    tagsContainer.insertBefore(span, tagsContainer.firstChild);
                                });
                            }

                            document.getElementById("btnCreateTag").onclick = async () => {
                                const name = document.getElementById("inputTagName").value.trim();
                                if (!name) return alert("Escribe un nombre");
                                await createTagForMovie(movieId, name);
                                document.getElementById("inputTagName").value = "";
                                bootstrap.Modal.getInstance(document.getElementById("modalTag")).hide();
                                renderCustomTags();
                            };

                            // Render tags personalizados al cargar
                            renderCustomTags();
                        });
                    </script>
                </div>
            </div>

            <div class="reviews mt-4">
                <h4>Reseñas de la comunidad</h4>
                <div class="review"><strong>User1:</strong> Review title</div>
                <div class="review"><strong>User2:</strong> Review title</div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR RESEÑA -->
<div class="modal fade" id="modalEditarResena" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Editar reseña</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4">
                <div class="mb-3">
                    <label class="form-label">Título</label>
                    <input type="text" class="form-control" id="editTituloResena" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Reseña</label>
                    <textarea class="form-control" id="editCuerpoResena" rows="5"></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 px-4 pb-4">
                <button type="button" class="btn-orange w-100 fw-bold" id="btnActualizarResena">Actualizar</button>
            </div>
        </div>
    </div>
</div>


<!-- MODAL ELIMINAR RESEÑA -->
<div class="modal fade" id="modalEliminarResena" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-trash me-2"></i>Eliminar reseña
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <p class="fw-semibold mb-2">¿Quieres eliminar esta reseña?</p>
                <p class="text-danger fw-bold">Esta acción no se puede deshacer.</p>
            </div>

            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger px-4" id="confirmDeleteReview">Eliminar</button>
            </div>
        </div>
    </div>
</div>



<!-- MODAL EDITAR COMENTARIO -->
<div class="modal fade" id="modalEditarComentario" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Editar comentario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4">
                <div class="mb-3">
                    <label class="form-label">Comentario</label>
                    <textarea class="form-control" id="editCuerpoComentario" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 px-4 pb-4">
                <button type="button" class="btn-orange w-100 fw-bold" id="btnActualizarComentario">Actualizar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL ELIMINAR COMENTARIO -->
<div class="modal fade" id="modalEliminarComentario" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-trash me-2"></i>Eliminar comentario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body text-center">
                <p class="fw-semibold mb-2">¿Quieres eliminar este comentario?</p>
                <p class="text-danger fw-bold">Esta acción no se puede deshacer.</p>
            </div>

            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger px-4" id="confirmDeleteComment">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CREAR COMENTARIO -->
<div class="modal fade" id="modalCrearComentario" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Escribir comentario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4">
                <div class="mb-3">
                    <label class="form-label">Comentario</label>
                    <textarea class="form-control" id="nuevoComentarioCuerpo" rows="4" placeholder="Escribe tu comentario..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 px-4 pb-4">
                <button type="button" class="btn-orange w-100 fw-bold" id="btnCrearComentario">Publicar comentario</button>
            </div>
        </div>
    </div>
</div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_KEY = '65f588c6445a775c9a45fed2ecb97ae4';
        const BASE_URL = 'https://api.themoviedb.org/3/movie/';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';


        

        async function loadMovieDetails(movieId) {
            try {
                const detailUrl = `${BASE_URL}${movieId}?api_key=${API_KEY}&language=es-ES`;
                const detailResponse = await fetch(detailUrl);
                if (!detailResponse.ok) throw new Error('No encontrado');
                const movie = await detailResponse.json();

                document.getElementById("movie-title").textContent = movie.title;
                document.getElementById("movie-description").textContent = movie.overview || 'Sinopsis no disponible.';
                document.getElementById("movie-year").textContent = movie.release_date ? movie.release_date.substring(0,4) : 'N/A';
                document.getElementById("movie-poster").src = movie.poster_path ? IMAGE_BASE_URL + movie.poster_path : 'https://via.placeholder.com/200x300?text=No+Poster';

                const tagsContainer = document.getElementById("movie-tags");
                const firstBtn = tagsContainer.querySelector('button');
                tagsContainer.querySelectorAll('span').forEach(s => s.remove());
                (movie.genres || []).forEach(g => {
                    const span = document.createElement('span');
                    span.textContent = g.name;
                    tagsContainer.insertBefore(span, firstBtn);
                });

                const creditsUrl = `${BASE_URL}${movieId}/credits?api_key=${API_KEY}`;
                const creditsResp = await fetch(creditsUrl);
                const credits = await creditsResp.json();
                const director = (credits.crew || []).find(c => c.job === 'Director');
                document.getElementById("movie-director").textContent = director ? director.name : 'Desconocido';

            } catch (err) {
                document.getElementById("movie-title").textContent = 'Película no encontrada';
                document.getElementById("movie-description").textContent = 'Verifica el ID o la conexión.';
            }
        }

           
//         async function loadMovieReviews(movieId) {
//             const reviewsContainer = document.querySelector(".reviews");

//             // Mantener el título
//             reviewsContainer.innerHTML = `
//                 <h4>Reseñas de la comunidad</h4>
//                 <p class="text-secondary">Cargando reseñas...</p>
//             `;

//             try {
//                 // 1. Usar la ruta correcta
//                 const response = await fetch(`http://localhost:3000/api/reviews/all`);

//                 if (!response.ok) throw new Error("No se pudieron obtener las reseñas");

//                 const allReviews = await response.json();

//                 // 2. Filtrar por película
//                 const movieReviews = allReviews.filter(r => r.movie_id == movieId);

//                 // 3. Si no hay reseñas, mostrar aviso
//                 if (movieReviews.length === 0) {
//                     reviewsContainer.innerHTML = `
//                         <h4>Reseñas de la comunidad</h4>
//                         <p class="text-secondary">No hay reseñas para esta película aún.</p>
//                     `;
//                     return;
//                 }

//                 // 4. Limpiar debajo del título
//                 reviewsContainer.innerHTML = `<h4>Reseñas de la comunidad</h4>`;

//                 // 5. Crear las tarjetas
//                 movieReviews.forEach(review => {
//                     const div = document.createElement("div");
//                     div.className = "review-card mt-3";

//                     div.innerHTML = `
//                         <div class="review-header">
//                             <span class="review-user">${review.owner_name || "Usuario"}</span>

//                             <div class="review-actions">
//                                 <i class="fas fa-edit edit-review" data-id="${review.id}"></i>
//                                 <i class="fas fa-trash delete-review" data-id="${review.id}"></i>
//                             </div>
//                         </div>

//                         <div class="review-title">${review.title}</div>
//                         <div class="review-text">${review.description}</div>
                        
//                         <!-- BOTONES DE COMENTARIOS -->
//     <div class="mt-3">
//         <button class="btn btn-sm btn-primary ver-comentarios-btn" data-id="${review.id}">
//             Ver comentarios
//         </button>

//         <button class="btn btn-sm btn-outline-success escribir-comentario-btn" data-id="${review.id}">
//             Escribir comentario
//         </button>
//     </div>

//     <!-- CONTENEDOR DE COMENTARIOS -->
//     <div class="comentarios-container mt-2" id="comentarios-${review.id}" style="display:none;">
//         <p class="text-secondary small">Cargando comentarios...</p>
//     </div>

//                         `;


//                     reviewsContainer.appendChild(div);
//                 });

//             } catch (error) {
//                 console.error(error);
//                 reviewsContainer.innerHTML = `
//                     <h4>Reseñas de la comunidad</h4>
//                     <p class="text-danger">Error al cargar reseñas.</p>
//                 `;
//             }
// }


async function loadMovieReviews(movieId) {
    const reviewsContainer = document.querySelector(".reviews");

    reviewsContainer.innerHTML = `
        <h4>Reseñas de la comunidad</h4>
        <p class="text-secondary">Cargando reseñas...</p>
    `;

    try {
        const response = await fetch(`http://localhost:3000/api/reviews/all`);
        if (!response.ok) throw new Error("No se pudieron obtener las reseñas");

        const allReviews = await response.json();
        const movieReviews = allReviews.filter(r => r.movie_id == movieId);

        if (movieReviews.length === 0) {
            reviewsContainer.innerHTML = `
                <h4>Reseñas de la comunidad</h4>
                <p class="text-secondary">No hay reseñas para esta película aún.</p>
            `;
            return;
        }

        reviewsContainer.innerHTML = `<h4>Reseñas de la comunidad</h4>`;

        const currentUser = localStorage.getItem("user_id");

        movieReviews.forEach(review => {
            const div = document.createElement("div");
            div.className = "review-card mt-3";

           // console.log("Review:", review);

            div.innerHTML = `
                <div class="review-header">
                    <span class="review-user">${review.owner_name || "Usuario"}</span>

                    <div class="review-actions">
                        ${
                            review.owner == currentUser ? `
                                <i class="fas fa-edit edit-review" data-id="${review.id}"></i>
                                <i class="fas fa-trash delete-review" data-id="${review.id}"></i>
                            ` : ""
                        }
                    </div>
                </div>

                <div class="review-title">${review.title}</div>
                <div class="review-text">${review.description}</div>

                <!-- BOTONES DE COMENTARIOS -->
                <div class="mt-3">
                    <button class="btn btn-sm btn-primary ver-comentarios-btn" data-id="${review.id}">
                        Ver comentarios
                    </button>
                    <button class="btn btn-sm btn-outline-success escribir-comentario-btn" data-id="${review.id}">
                        Escribir comentario
                    </button>
                </div>

                <!-- CONTENEDOR DE COMENTARIOS -->
                <div class="comentarios-container mt-2" id="comentarios-${review.id}" style="display:none;">
                    <p class="text-secondary small">Cargando comentarios...</p>
                </div>
            `;

            reviewsContainer.appendChild(div);
        });

    } catch (error) {
        console.error(error);
        reviewsContainer.innerHTML = `
            <h4>Reseñas de la comunidad</h4>
            <p class="text-danger">Error al cargar reseñas.</p>
        `;
    }
}


// CLICK EN "Ver comentarios"

// document.addEventListener("click", (e) => {
//     if (e.target.classList.contains("ver-comentarios-btn")) {
//         const reviewId = e.target.dataset.id;

//         // Buscar contenedor
//         let cont = document.getElementById(`comentarios-${reviewId}`);

//         // Si no existe, crearlo dinámicamente
//         if (!cont) {
//             const reviewCard = e.target.closest('.review-card'); // busca la tarjeta padre
//             cont = document.createElement('div');
//             cont.className = 'comentarios-container mt-2';
//             cont.id = `comentarios-${reviewId}`;
//             cont.style.display = 'none';
//             reviewCard.appendChild(cont);
//         }

//         // Alternar visibilidad
//         if (cont.style.display === "none") {
//             cont.style.display = "block";
//             loadComentarios(reviewId, cont);
//         } else {
//             cont.style.display = "none";
//         }
//     }
// });

document.addEventListener("click", (e) => {
    if (e.target.classList.contains("ver-comentarios-btn")) {
        const reviewId = e.target.dataset.id;

        // Buscar contenedor de comentarios
        let cont = document.getElementById(`comentarios-${reviewId}`);

        // Buscar la tarjeta de la reseña
        const reviewCard = e.target.closest('.review-card');

        // Si no existe contenedor, crear solo si reviewCard existe
        if (!cont && reviewCard) {
            cont = document.createElement('div');
            cont.className = 'comentarios-container mt-2';
            cont.id = `comentarios-${reviewId}`;
            cont.style.display = 'none';
            reviewCard.appendChild(cont);
        }

        // Si cont todavía no existe (algo salió mal), salir
        if (!cont) return;

        // Alternar visibilidad y cargar comentarios
        if (cont.style.display === "none") {
            cont.style.display = "block";
            loadComentarios(reviewId, cont);
        } else {
            cont.style.display = "none";
        }
    }
});

/**
 * Cargar comentarios de un review
 * GET /api/comments?reviewId=ID
 */
// async function loadComentarios(reviewId, cont) {
//     cont.innerHTML = `<p class="text-secondary small">Cargando comentarios...</p>`;

//     try {
//         const res = await fetch(`http://localhost:3000/api/comments?reviewId=${reviewId}`);

//         if (!res.ok) {
//             cont.innerHTML = `<p class="text-danger small">No se pudieron obtener los comentarios.</p>`;
//             return;
//         }

//         const payload = await res.json();
//         const comments = Array.isArray(payload) ? payload : (payload.data || []);

//         if (comments.length === 0) {
//             cont.innerHTML = `<p class="text-secondary small">No hay comentarios aún.</p>`;
//             return;
//         }

//         cont.innerHTML = comments.map(c => `
//             <div class="p-2 border rounded mb-2">
//                 <div class="d-flex justify-content-between">
//                     <strong>${c.owner_name || "Usuario"}</strong>
//                     <small class="text-muted">${new Date(c.created_at).toLocaleString()}</small>
//                 </div>
//                 <div class="mt-1">${(c.content || "").replace(/</g, "&lt;")}</div>
//             </div>
//         `).join("");

//     } catch (error) {
//         console.error(error);
//         cont.innerHTML = `<p class="text-danger small">Error al cargar comentarios.</p>`;
//     }
// }

async function loadComentarios(reviewId, cont) {
    
    if (!cont) {
        //console.warn("No existe el contenedor de comentarios para reviewId", reviewId);
        return; // salir si no hay contenedor
    }

    cont.innerHTML = `<p class="text-secondary small">Cargando comentarios...</p>`;

    try {
        const res = await fetch(`http://localhost:3000/api/comments?reviewId=${reviewId}`);
        if (!res.ok) {
            cont.innerHTML = `<p class="text-danger small">No se pudieron obtener los comentarios.</p>`;
            return;
        }

        const payload = await res.json();
        const comments = Array.isArray(payload) ? payload : (payload.data || []);

        if (comments.length === 0) {
            cont.innerHTML = `<p class="text-secondary small">No hay comentarios aún.</p>`;
            return;
        }

        const currentUser = localStorage.getItem("user_id");

        cont.innerHTML = comments.map(c => `
            <div class="p-2 border rounded mb-2 comment-card" data-id="${c.id}">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${c.owner_name || "Usuario"}</strong>
                    <div>
                        <small class="text-muted me-2">${new Date(c.created_at).toLocaleString()}</small>
                        ${
                            c.owner == currentUser ? `
                                <i class="fas fa-edit edit-comment" data-id="${c.id}" style="cursor:pointer; margin-right:8px;"></i>
                                <i class="fas fa-trash delete-comment" data-id="${c.id}" style="cursor:pointer;"></i>
                            ` : ""
                        }
                    </div>
                </div>
                <div class="mt-1">${(c.content || "").replace(/</g, "&lt;")}</div>
            </div>
        `).join("");

    } catch (error) {
        console.error(error);
        cont.innerHTML = `<p class="text-danger small">Error al cargar comentarios.</p>`;
    }
}


let commentToEdit = null;

document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("edit-comment")) {
        const commentId = e.target.dataset.id;

        try {
            const res = await fetch(`http://localhost:3000/api/comments/${commentId}`, {
                headers: { "x-auth": localStorage.getItem("user_auth_key") }
            });
            if (!res.ok) throw new Error("No se pudo obtener el comentario");
            const comment = await res.json();

            const userId = localStorage.getItem("user_id");
            if (comment.owner != userId) {
                alert("No puedes editar este comentario");
                return;
            }

            document.getElementById("editCuerpoComentario").value = comment.content;
            commentToEdit = commentId;

            const modal = new bootstrap.Modal(document.getElementById("modalEditarComentario"));
            modal.show();

        } catch (err) {
            console.error(err);
            alert("Error al obtener el comentario");
        }
    }
});




async function fetchReviewById(id) {
    try {
        const response = await fetch(`http://localhost:3000/api/reviews/${id}`, {
            headers: {
                "x-auth": localStorage.getItem("user_auth_key")
            }
        });
        if (!response.ok) throw new Error("No se pudo obtener la reseña");
        return await response.json();
    } catch (err) {
        console.error(err);
        alert("Error al obtener la reseña");
    }
}

// delete 
let reviewToDelete = null;

// CLICK EN ICONO DE BASURA
document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("delete-review")) {

        reviewToDelete = e.target.dataset.id;

        // 1. Obtener reseña
        const review = await fetchReviewById(reviewToDelete);
        const userId = localStorage.getItem("user_id");

        // 2. Validar dueño
        if (review.owner != userId) {
            alert("No puedes eliminar esta reseña porque no es tuya.");
            reviewToDelete = null;
            return;
        }

        // 3. Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById("modalEliminarResena"));
        modal.show();
    }
});


// CONFIRMAR ELIMINACIÓN
document.getElementById("confirmDeleteReview").addEventListener("click", async () => {

    if (!reviewToDelete) return;

    try {
        const res = await fetch(`http://localhost:3000/api/reviews/${reviewToDelete}`, {
            method: "DELETE",
            headers: {
                "x-auth": localStorage.getItem("user_auth_key")
            }
        });

        if (!res.ok) {
            alert("Error al eliminar reseña.");
            return;
        }

        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById("modalEliminarResena")).hide();

        // Recargar reseñas
        const params = new URLSearchParams(window.location.search);
        const movieId = params.get("id") || 105;
        loadMovieReviews(movieId);

        reviewToDelete = null;

    } catch (err) {
        console.error(err);
        alert("Ocurrió un error al eliminar tu reseña.");
    }
});





document.getElementById("btnActualizarResena").addEventListener("click", async () => {
    const reviewId = document.getElementById("btnActualizarResena").dataset.id;
    const title = document.getElementById("editTituloResena").value.trim();
    const description = document.getElementById("editCuerpoResena").value.trim();
    const rating = 5; // ejemplo
    const tags = [];

    if (!title || !description) {
        alert("Completa el título y la reseña.");
        return;
    }

    try {
        const response = await fetch(`http://localhost:3000/api/reviews/${reviewId}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "x-auth": localStorage.getItem("user_auth_key")
            },
            body: JSON.stringify({ title, description, rating, tags })
        });

        if (!response.ok) throw new Error("Error al actualizar reseña");

        bootstrap.Modal.getInstance(document.getElementById("modalEditarResena")).hide();

        // Recargar reseñas
        const params = new URLSearchParams(window.location.search);
        const movieId = params.get("id") || 105;
        loadMovieReviews(movieId);

    } catch (err) {
        console.error(err);
        alert("Ocurrió un error al actualizar tu reseña.");
    }
});


document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("edit-review")) {
        const reviewId = e.target.dataset.id;
        const review = await fetchReviewById(reviewId); // función que crearemos
        const userId = localStorage.getItem("user_id"); // id del usuario logueado

        if (review.owner != userId) {
            alert("No escribiste esta reseña, no puedes editarla.");
            return;
        }

        // Abrir modal con datos
        const modal = new bootstrap.Modal(document.getElementById("modalEditarResena"));
        document.getElementById("editTituloResena").value = review.title;
        document.getElementById("editCuerpoResena").value = review.description;
        modal.show();

        // Guardar temporalmente el id para actualizar
        document.getElementById("btnActualizarResena").dataset.id = reviewId;
    }
});



        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get("id") || 105;
            loadMovieDetails(id);
            loadMovieReviews(id);
            


           




            const logoutBtn = document.getElementById("logoutBtn");
            const logoutModal = new bootstrap.Modal(document.getElementById("modalLogout"));
            logoutBtn.addEventListener("click", () => logoutModal.show());

            document.getElementById("confirmLogout").addEventListener("click", () => {
                window.location.href = "PW_login.html";
            });

            const heartIcon = document.getElementById("heartIcon");
            heartIcon.addEventListener("click", () => {
                heartIcon.classList.toggle("active");
                heartIcon.classList.toggle("fas");
                heartIcon.classList.toggle("far");
            });

            const stars = document.querySelectorAll("#starContainer i");
            const selectedRating = document.getElementById("selectedRating");

            stars.forEach((star, idx) => {
                star.addEventListener("mouseenter", () => {
                    stars.forEach((s,i) => s.classList.toggle('fas', i <= idx));
                    stars.forEach((s,i) => s.classList.toggle('far', i > idx));
                });

                star.addEventListener("mouseleave", () => {
                    const sel = parseInt(selectedRating.value, 10) || 0;
                    stars.forEach((s,i) => {
                        s.classList.toggle('fas', i < sel);
                        s.classList.toggle('far', i >= sel);
                    });
                });

                star.addEventListener("click", () => {
                    const value = parseInt(star.dataset.value, 10);
                    selectedRating.value = value;
                    stars.forEach((s,i) => {
                        s.classList.toggle('fas', i < value);
                        s.classList.toggle('far', i >= value);
                    });
                });
            });

            document.getElementById("submitRatingBtn").addEventListener("click", () => {
                const val = selectedRating.value || 0;
                alert(`Valoración enviada: ${val} estrellas`);
                bootstrap.Modal.getInstance(document.getElementById('modalCalificar')).hide();
            });

            document.getElementById("addCategoryBtn").addEventListener("click", () => {
                const input = document.getElementById("newCategory");
                const val = input.value.trim();
                if (!val) return;

                const tagsContainer = document.getElementById("movie-tags");
                const btn = tagsContainer.querySelector('button');
                const span = document.createElement('span');
                span.textContent = val;
                tagsContainer.insertBefore(span, btn);

                input.value = '';
                bootstrap.Modal.getInstance(document.getElementById('modalCategoria')).hide();
            });

            document.getElementById("btnPublicarResena").addEventListener("click", async () => {
    const title = document.getElementById("tituloResena").value.trim();
    const description = document.getElementById("cuerpoResena").value.trim();
    const rating =  5; // ejemplo
    const due_date = new Date().toISOString().split("T")[0]; // "2025-11-24"

    if (!title || !description) {
        alert("Completa el título y la reseña.");
        return;
    }

    const params = new URLSearchParams(window.location.search);
    const movieId = params.get("id") || 105;

    try {
        const response = await fetch("http://localhost:3000/api/reviews", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-auth": localStorage.getItem("user_auth_key")
            },
            body: JSON.stringify({
                movie_id: movieId,
                title,
                description,
                due_date,
                rating,
                tags: []
            })
        });

        if (!response.ok) throw new Error("Error al crear reseña");

        bootstrap.Modal.getInstance(document.getElementById("modalResena")).hide();

        document.getElementById("tituloResena").value = "";
        document.getElementById("cuerpoResena").value = "";

        loadMovieReviews(movieId);

    } catch (err) {
        console.error(err);
        alert("Ocurrió un error al publicar tu reseña.");
    }
});

        });




    document.getElementById("btnActualizarComentario").addEventListener("click", async () => {
    const newContent = document.getElementById("editCuerpoComentario").value.trim();
    if (!newContent) return alert("El comentario no puede estar vacío");

    try {
        const res = await fetch(`http://localhost:3000/api/comments/${commentToEdit}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "x-auth": localStorage.getItem("user_auth_key")
            },
            body: JSON.stringify({ content: newContent })
        });

        if (!res.ok) throw new Error("Error al actualizar comentario");

        bootstrap.Modal.getInstance(document.getElementById("modalEditarComentario")).hide();
       // loadComentarios(data.review_id, document.getElementById(`comentarios-${data.review_id}`))
     
       const commentCard = document.querySelector(`.comment-card[data-id="${commentToEdit}"]`);
        if (commentCard) {
            const reviewId = commentCard.closest('.comentarios-container').id.split('-')[1];
            const cont = document.getElementById(`comentarios-${reviewId}`);
            loadComentarios(reviewId, cont);
        }

        commentToEdit = null;

    } catch (err) {
        console.error(err);
        alert("Ocurrió un error al actualizar tu comentario");
    }
});



let commentToDelete = null;

// CLICK EN ICONO DE BASURA DE COMENTARIO
document.addEventListener("click", (e) => {
    if (e.target.classList.contains("delete-comment")) {
        commentToDelete = e.target.dataset.id;

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById("modalEliminarComentario"));
        modal.show();
    }
});

// CONFIRMAR ELIMINACIÓN DE COMENTARIO
document.getElementById("confirmDeleteComment").addEventListener("click", async () => {
    if (!commentToDelete) return;

    try {
        const res = await fetch(`http://localhost:3000/api/comments/${commentToDelete}`, {
            method: "DELETE",
            headers: {
                "x-auth": localStorage.getItem("user_auth_key")
            }
        });

        if (!res.ok) throw new Error("Error al eliminar comentario");

        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById("modalEliminarComentario")).hide();

        // Eliminar de la UI
        const commentCard = document.querySelector(`.comment-card[data-id="${commentToDelete}"]`);
        if (commentCard) commentCard.remove();

        commentToDelete = null;

    } catch (err) {
        console.error(err);
        alert("Ocurrió un error al eliminar el comentario");
    }
});


let reviewIdToComment = null; // Guardamos la reseña en la que se está comentando

// Abrir modal para escribir comentario
document.addEventListener("click", (e) => {
    if (e.target.classList.contains("escribir-comentario-btn")) {
        reviewIdToComment = e.target.dataset.id; // Guardamos el ID de la reseña
        //document.getElementById("nuevoComentarioCuerpo").value = ""; // limpiar textarea
        const modal = new bootstrap.Modal(document.getElementById("modalCrearComentario"));
        modal.show();
    }
});

// Crear comentario
document.getElementById("btnCrearComentario").addEventListener("click", async () => {
    const content = document.getElementById("nuevoComentarioCuerpo").value.trim();
    if (!content) return alert("El comentario no puede estar vacío");
    if (!reviewIdToComment) return alert("No se pudo determinar la reseña para el comentario");

    try {
        const res = await fetch("http://localhost:3000/api/comments", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-auth": localStorage.getItem("user_auth_key")
            },
            body: JSON.stringify({
                id_review: reviewIdToComment,
                owner: localStorage.getItem("user_id"),
                content,
                date: new Date().toISOString()
            })
        });

        if (!res.ok) throw new Error("Error al crear comentario");

        // Cerrar modal y limpiar textarea
        bootstrap.Modal.getInstance(document.getElementById("modalCrearComentario")).hide();
        document.getElementById("nuevoComentarioCuerpo").value = "";

        // Recargar comentarios de la reseña
        const cont = document.getElementById(`comentarios-${reviewIdToComment}`);
        if (cont) loadComentarios(reviewIdToComment, cont);

        reviewIdToComment = null;

    } catch (err) {
        console.error(err);
        alert("Ocurrió un error al publicar tu comentario");
    }
});

import("./../scripts/watchlist.js").then(() => {
    const heart = document.getElementById("heartIcon");
    const movieId = new URLSearchParams(window.location.search).get("id");

    async function updateHeartState() {
        const list = await getUserWatchlist();
        const exists = list.some(item => item.movie_id == movieId);

        if (exists) {
            heart.classList.add("active");
            heart.classList.remove("far");
            heart.classList.add("fas");
        } else {
            heart.classList.remove("active");
            heart.classList.remove("fas");
            heart.classList.add("far");
        }
    }

    // Inicializar estado
    updateHeartState();

    // Toggle al hacer clic
    heart.addEventListener("click", async () => {
        const ok = await toggleWatchlistFromMovie(movieId);
        if (ok) updateHeartState();
    });
});



    </script>

    <script src="../scripts/watchlist.js"></script>

</body>
</html>
